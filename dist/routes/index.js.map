{"version":3,"sources":["../../routes/index.js"],"names":["express","require","router","Router","_","request","get","req","res","next","console","log","process","env","IGNITEAI_URI","render","title","query","VERIFY_TOKEN","status","send","error","sendStatus","post","data","body","object","entry","forEach","pageID","id","timeOfEvent","time","messaging","event","message","receivedMessage","postback","receivedPostback","senderID","sender","recipientID","recipient","timeOfMessage","timestamp","JSON","stringify","messageID","messageText","text","messageAttachment","attachments","sendGenericMessage","sendTextMessage","recipientId","messageData","attachment","type","payload","template_type","elements","subtitle","item_url","image_url","buttons","url","callSendAPI","uri","qs","access_token","PAGE_ACCESS_TOKEN","method","json","response","statusCode","recipient_id","messageId","message_id","timeOfPostback","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\nlet express = require('express');\nlet router = express.Router();\nlet _ = require('lodash')\nlet request = require('request')\n/* GET home page. */\nrouter.get('/', function (req, res, next) {\n    console.log(process.env.IGNITEAI_URI)\n    res.render('index', {title: 'Ignite AI'});\n});\n\nrouter.get('/webhook', function (req, res) {\n    if(req.query['hub.mode'] === 'subscribe' &&\n        req.query['hub.verify_token'] === process.env.VERIFY_TOKEN) {\n        console.log(\"Validating webhook\");\n        res.status(200).send(req.query['hub.challenge']);\n    } else {\n        console.error(\"Failed validation. Make sure the validation tokens match.\");\n        res.sendStatus(403);\n    }\n});\n\nrouter.post('/webhook', (req, res, next) => {\n    \n    let data = req.body;\n    \n    if(data.object === 'page') {\n        \n        data.entry.forEach((entry) => {\n            \n            let pageID = entry.id;\n            let timeOfEvent = entry.time;\n            \n            entry.messaging.forEach((event) => {\n                console.log(event)\n                if(event.message) {\n                    receivedMessage(event)\n                } else if(event.postback) {\n                    receivedPostback(event);\n                } else {\n                    console.log(\"Webhook received unkown event: %s\", event)\n                }\n                \n            })\n            \n        });\n        \n    }\n    \n    res.sendStatus(200);\n    \n})\n\nfunction receivedMessage(event) {\n    console.log('Message data: %s', event.data)\n    \n    let senderID = event.sender.id;\n    let recipientID = event.recipient.id;\n    let timeOfMessage = event.timestamp;\n    let message = event.message;\n    console.log(\"Received message for user %d and page %d at %d with message:\", senderID, recipientID, timeOfMessage);\n    console.log(JSON.stringify(message));\n    \n    let messageID = message.id;\n    let messageText = message.text;\n    let messageAttachment = message.attachments;\n    if(messageText) {\n        \n        switch (messageText) {\n            case 'generic':\n                sendGenericMessage(senderID, messageText);\n                break;\n            default:\n                sendTextMessage(senderID, messageText);\n                break;\n        }\n        \n    }\n    \n}\nfunction sendGenericMessage(recipientId, messageText) {\n    \n    let messageData = {\n        recipient: {\n            id: recipientId\n        },\n        message: {\n            attachment: {\n                type: \"template\",\n                payload: {\n                    template_type: \"generic\",\n                    elements: [{\n                        title: \"rift\",\n                        subtitle: \"Next-generation marketing AI\",\n                        // item_url: \"https://www.oculus.com/en-us/rift/\",\n                        item_url: process.env.IGNITEAI_URI,\n                        image_url: process.env.IGNITEAI_URI + 'images/ss.png',\n                        buttons: [{\n                            type: \"web_url\",\n                            url: process.env.IGNITEAI_URI,\n                            title: \"Open Web URL\"\n                        }, {\n                            type: \"postback\",\n                            title: \"Call Postback\",\n                            payload: \"Payload for first bubble\",\n                        }],\n                    }, {\n                        title: \"touch\",\n                        subtitle: \"Your Hands, Now in VR\",\n                        item_url: process.env.IGNITEAI_URI + 'ignite/',\n                        image_url: process.env.IGNITEAI_URI + 'images/ss.png',\n                        buttons: [{\n                            type: \"web_url\",\n                            url: process.env.IGNITEAI_URI + 'ignite/',\n                            title: \"Open Web URL\"\n                        }, {\n                            type: \"postback\",\n                            title: \"Call Postback\",\n                            payload: \"Payload for second bubble\",\n                        }]\n                    }]\n                }\n            }\n        }\n    };\n    \n    callSendAPI(messageData);\n}\n\nfunction sendTextMessage(recipientID, messageText) {\n    let messageData = {\n        recipient: {\n            id: recipientID,\n        },\n        message: {\n            text: messageText\n        }\n    };\n    callSendAPI(messageData);\n}\n\nfunction callSendAPI(messageData) {\n    \n    request({\n        uri: 'https://graph.facebook.com/v2.6/me/messages',\n        qs: {access_token: process.env.PAGE_ACCESS_TOKEN},\n        method: 'POST',\n        json: messageData\n    }, (error, response, body) => {\n        if(!error && response.statusCode === 200) {\n            let recipientId = body.recipient_id;\n            let messageId = body.message_id;\n            console.log(\"Successfully sent generic message with id %s to recipient %s\", messageId, recipientId);\n            \n        } else {\n            console.error('Unable to send message.')\n            console.error(response);\n            console.error(error);\n        }\n    })\n    \n}\n\nfunction receivedPostback(event) {\n    let senderID = event.sender.id;\n    let recipientID = event.recipient.id;\n    let timeOfPostback = event.timestamp;\n    let payload = event.postback.payload;\n    console.log(\"Received postback for user %d and page %d with payload '%s' \" + \"at %d\", senderID, recipientID, payload, timeOfPostback);\n    sendTextMessage(senderID, \"Postback celled\");\n}\n\nmodule.exports = router;\n"]}